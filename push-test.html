<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>fnothing Â· Web Push Test</title>
  <style>
    body{font:14px system-ui;margin:24px}
    button{padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#f6f7f9;cursor:pointer}
    pre{background:#0b0b0c;color:#f4f4f5;padding:12px;border-radius:10px;white-space:pre-wrap}
    code{background:#eee;padding:2px 6px;border-radius:6px}
  </style>

  <!-- www â†’ non-www ZWINGEN (muss VOR OneSignal laden) -->
  <script>
    (function () {
      if (location.hostname.startsWith('www.')) {
        location.replace(location.href.replace('//www.', '//'));
      }
    })();
  </script>

  <!-- OneSignal v16 SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
</head>
<body>
  <h1>fnothing Â· Web Push Test</h1>
  <p>Origin: <code id="origin"></code></p>
  <p>1) Klicke zuerst <b>Status aktualisieren</b>. 2) Danach <b>Prompt anzeigen</b>.</p>

  <div style="display:flex;gap:8px;margin:12px 0;">
    <button id="btn-status">Status aktualisieren</button>
    <button id="btn-prompt">ðŸ”” Prompt anzeigen</button>
    <button id="btn-reset">SW/Cache reset</button>
  </div>

  <pre id="out">â€¦</pre>

  <script>
    const $ = s => document.querySelector(s);
    const out = $('#out');
    const originEl = $('#origin');
    originEl.textContent = location.origin;

    function log(v){
      out.textContent += (typeof v === 'string' ? v : JSON.stringify(v, null, 2)) + "\n";
    }

    window.OneSignalDeferred = window.OneSignalDeferred || [];
    window.OneSignalDeferred.push(async function(OneSignal) {
      try{
        await OneSignal.init({
          appId: "9fe27bc6-4db2-4381-83ed-21e9fec4fec0",
          serviceWorkerPath: "/OneSignalSDKWorker.js",
          serviceWorkerUpdaterPath: "/OneSignalSDKUpdaterWorker.js",
          serviceWorkerParam: { scope:"/" }
        });

        async function status(label){
          const supported = await OneSignal.Notifications.isPushSupported();
          const perm = await OneSignal.Notifications.permission;     // "default" | "granted" | "denied"
          const subId = await OneSignal.User.pushSubscriptionId;     // null wenn nicht subscribed
          const regs = ('serviceWorker' in navigator) ? await navigator.serviceWorker.getRegistrations() : [];
          log({
            label,
            href: location.href,
            origin: location.origin,
            supported,
            permission: perm,
            subscriptionId: subId,
            swScopes: regs.map(r => r.scope)
          });
        }

        $('#btn-status').onclick = () => status('status');

        $('#btn-prompt').onclick = async () => {
          try {
            if (OneSignal.Slidedown?.promptPush) {
              await OneSignal.Slidedown.promptPush();
            } else {
              await OneSignal.Notifications.requestPermission();
            }
            await OneSignal.User.addTag("signals","true");
          } catch (e) {
            log("prompt error: " + (e && e.message ? e.message : e));
          }
          await status('after prompt');
        };

        $('#btn-reset').onclick = async () => {
          try {
            if ('serviceWorker' in navigator) {
              const regs = await navigator.serviceWorker.getRegistrations();
              for (const r of regs) await r.unregister();
            }
            if (window.caches) {
              const keys = await caches.keys();
              for (const k of keys) await caches.delete(k);
            }
            localStorage.clear();
            sessionStorage.clear();
            log("Reset done. Seite neu laden.");
          } catch (e) {
            log("reset error: " + (e && e.message ? e.message : e));
          }
        };

        await status('init');
      } catch (e) {
        log("init error: " + (e && e.message ? e.message : e) + " | href=" + location.href + " | origin=" + location.origin);
      }
    });
  </script>
</body>
</html>
